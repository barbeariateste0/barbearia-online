<!doctype html>
<html lang="pt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Barbearia Online ‚Äî Marca√ß√£o</title>
  <style>
    body{font-family:system-ui,Arial;margin:24px;max-width:720px}
    label{display:block;margin-top:12px;font-weight:600}
    input,select,textarea,button{width:100%;padding:10px;margin-top:6px;font-size:16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .ok{background:#e7ffe7;padding:12px;border:1px solid #9be09b;margin-top:12px;display:none}
    .err{background:#ffe7e7;padding:12px;border:1px solid #e09b9b;margin-top:12px;display:none}
    .hint{font-size:13px;opacity:.8;margin-top:6px}
    button{cursor:pointer}
  </style>
</head>
<body>
  <h1>Barbearia Neves</h1>
  <p>Preenche e confirma. A marca√ß√£o entra automaticamente na agenda.</p>

  <div id="ok" class="ok"></div>
  <div id="err" class="err"></div>

  <form id="f">
    <label>Nome</label>
    <input name="name" required placeholder="Nome do cliente">

    <div class="row">
      <div>
        <label>Telefone</label>
        <input name="phone" required placeholder="9xx xxx xxx">
      </div>
      <div>
        <label>Email (opcional)</label>
        <input name="email" type="email" placeholder="email@exemplo.com">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Servi√ßo</label>
        <select name="service" required>
          <option value="Corte">Corte</option>
          <option value="Barba">Barba</option>
          <option value="Corte+Barba">Corte+Barba</option>
        </select>
      </div>
      <div>
        <label>Barbeiro</label>
        <select id="barber" name="barber" required>
          <option value="Pedro">Pedro Neves</option>
          <option value="Joao">Joao Leite</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Data</label>
        <input id="date" name="date" type="date" required>
      </div>
      <div>
        <label>Hora (dispon√≠vel)</label>
        <!-- troc√°mos input time por select -->
        <select id="time" name="time" required>
          <option value="">Escolhe data/barbeiro‚Ä¶</option>
        </select>
        <div class="hint" id="timeHint">Escolhe a data e o barbeiro para ver hor√°rios livres.</div>
      </div>
    </div>

    <label>Dura√ß√£o (min)</label>
    <input id="dur" name="dur" type="number" min="10" max="240" step="5" value="30" required>
    <div class="hint">S√≥ aparecem hor√°rios v√°lidos (ex: 14:30, 14:35‚Ä¶)</div>

    <label>Notas (opcional)</label>
    <textarea name="notes" rows="4" placeholder="Ex: atrasado 10 min, etc"></textarea>

    <button id="btn" type="submit">Marcar</button>
  </form>

  <script>
    // üëá Mete aqui o teu Render URL (SEM barra no fim)
    const API_BASE = "https://barbearia-api-ki25.onrender.com";

    const ok = document.getElementById('ok');
    const err = document.getElementById('err');
    const btn = document.getElementById('btn');

    const dateEl = document.getElementById('date');
    const barberEl = document.getElementById('barber');
    const durEl = document.getElementById('dur');
    const timeEl = document.getElementById('time');
    const timeHint = document.getElementById('timeHint');

    function show(el, text) { el.textContent = text; el.style.display = 'block'; }
    function hide(el) { el.style.display = 'none'; }

    function setTimeOptions(items, placeholder) {
      timeEl.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder || "Escolhe‚Ä¶";
      timeEl.appendChild(opt0);

      for (const t of items) {
        const o = document.createElement("option");
        o.value = t;
        o.textContent = t;
        timeEl.appendChild(o);
      }
    }

    async function loadSlots() {
      hide(ok); hide(err);

      const date = dateEl.value;
      const barber = barberEl.value;
      const dur = durEl.value || 30;

      if (!date || !barber) {
        setTimeOptions([], "Escolhe data/barbeiro‚Ä¶");
        timeHint.textContent = "Escolhe a data e o barbeiro para ver hor√°rios livres.";
        return;
      }

      timeHint.textContent = "A carregar hor√°rios...";
      setTimeOptions([], "A carregar...");

      try {
        const url = `${API_BASE}/slots?date=${encodeURIComponent(date)}&barber=${encodeURIComponent(barber)}&dur=${encodeURIComponent(dur)}`;
        const r = await fetch(url);
        const j = await r.json().catch(()=> ({}));

        if (!r.ok || !j.ok) throw new Error(j.error || ("Erro HTTP " + r.status));

        if (!j.slots || !j.slots.length) {
          setTimeOptions([], "Sem vagas nesse dia");
          timeHint.textContent = "N√£o h√° hor√°rios livres para essa dura√ß√£o/barbeiro nesse dia.";
          return;
        }

        setTimeOptions(j.slots, "Seleciona uma hora");
        timeHint.textContent = "Hor√°rios atualizados. Escolhe uma hora livre.";
      } catch (ex) {
        setTimeOptions([], "Erro a carregar");
        timeHint.textContent = "N√£o foi poss√≠vel carregar hor√°rios. Tenta de novo.";
        show(err, "‚ùå Erro a carregar hor√°rios: " + ex.message);
      }
    }

    // Atualiza slots quando muda data/barbeiro/dura√ß√£o
    dateEl.addEventListener("change", loadSlots);
    barberEl.addEventListener("change", loadSlots);
    durEl.addEventListener("change", loadSlots);

    // (opcional) meter data de hoje automaticamente
    (function initDate(){
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      if (!dateEl.value) dateEl.value = `${yyyy}-${mm}-${dd}`;
      loadSlots();
    })();

    document.getElementById('f').addEventListener('submit', async (e) => {
      e.preventDefault();
      hide(ok); hide(err);

      const fd = new FormData(e.target);
      const payload = Object.fromEntries(fd.entries());

      // time vem do select j√° em HH:MM
      if (payload.time && payload.time.length >= 5) payload.time = payload.time.slice(0,5);

      btn.disabled = true;
      btn.textContent = "A marcar...";

      try {
        const r = await fetch(API_BASE + "/book", {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });

        const data = await r.json().catch(()=> ({}));

        // conflito -> 409 com { ok:false, error:"conflict", conflict_with:{...}}
        if (r.status === 409 && data && data.error === "conflict") {
          const c = data.conflict_with || {};
          throw new Error(`Hor√°rio ocupado. J√° existe: ${c.time || "?"} (${c.dur || "?"} min) ‚Äî ${c.name || ""}`);
        }

        if (!r.ok) throw new Error(data.error || ("Erro HTTP " + r.status));

        show(ok, "‚úÖ Marca√ß√£o recebida! ID: " + (data.id || "(sem id)") + " ‚Äî vai entrar na agenda em segundos.");
        e.target.reset();

        // rep√µe data para hoje e recarrega slots
        initDate();
      } catch (ex) {
        show(err, "‚ùå N√£o foi poss√≠vel marcar: " + ex.message);
      } finally {
        btn.disabled = false;
        btn.textContent = "Marcar";
        // recarrega slots (para tirar a hora marcada)
        loadSlots();
      }
    });

    // fun√ß√£o usada acima (repor data e recarregar slots)
    function initDate(){
      const today = new Date();
      const yyyy = today.getFullYear();
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const dd = String(today.getDate()).padStart(2,'0');
      dateEl.value = `${yyyy}-${mm}-${dd}`;
      loadSlots();
    }
  </script>
</body>
</html>
